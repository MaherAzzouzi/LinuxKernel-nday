#include <stdio.h>
#include <unistd.h>
#include <sys/mman.h>
#include <linux/futex.h>
#include <stdint.h>
#include <sys/time.h>
#include <sys/syscall.h>
#include <stdatomic.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/wait.h>

#define FUTEX_WAIT_ERR -1337
#define FUTEX_WAKE_ERR -1338

uint32_t* futex0, *futex1;
uint32_t* shared_addr;

void futex_wait(uint32_t* fp) {
	
	while(1) {
		uint32_t one = 1;
		if (atomic_compare_exchange_strong(fp, &one, 0))
				break;

		long s = syscall(SYS_futex, fp, FUTEX_WAIT, 0, NULL, NULL, 0);
		if (s == -1 && errno != EAGAIN)
				exit(FUTEX_WAIT_ERR);
	}
}


void futex_release(uint32_t* fp) {
	uint32_t zero = 0;
	if(atomic_compare_exchange_strong(fp, &zero, 1)) {
		long s = syscall(SYS_futex, fp, FUTEX_WAKE, 1, NULL, NULL, 0);
		if(s == -1)
				exit(FUTEX_WAKE_ERR);
	}
}

int main() {
	
	pid_t child;
	
	setbuf(stdout, NULL);
	setbuf(stdin, NULL);

	shared_addr = (uint32_t*)mmap(NULL,
					sizeof(uint32_t)*2,
					PROT_READ|PROT_WRITE,
					MAP_ANONYMOUS|MAP_SHARED,
					-1,
					0);

	futex0 = &shared_addr[0];
	futex1 = &shared_addr[1];
	
	*futex0 = 0;
	*futex1 = 1;

	child = fork();

	if(child == 0) {
		for(int i=0; i<10; i++) {
			futex_wait(futex0);
			printf("Child output N=%d\n", i);
			futex_release(futex1);
		}

		exit(child);
	}

	for(int i=0; i<10; i++) {
		futex_wait(futex1);
		printf("Parent output N=%d\n", i);
		futex_release(futex0);
	}

	wait(NULL);
	exit(getpid());
}
